name: AKS Start/Stop

on:
  workflow_dispatch:
    inputs:
      action:
        description: "AKS cluster status"
        required: true
        default: "stop"
        type: choice
        options:
          - start
          - stop

  # GitHub cron uses UTC. 19:00 Europe/Bucharest â‰ˆ 17:00 UTC.
  schedule:
    - cron: "0 17 * * *"

env:
  # Azure authentication
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

  AKS_RESOURCE_GROUP: homelab-rg
  AKS_CLUSTER_NAME: aks-engine-homelab

  AKS_ACTION: ${{ github.event.inputs.action || 'stop' }}

jobs:
  aks-power:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Azure CLI login using ARM_* env
        run: |
          echo "Logging into Azure with service principal..."
          az login --service-principal \
            --username "$ARM_CLIENT_ID" \
            --password "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"

          echo "Setting subscription..."
          az account set --subscription "$ARM_SUBSCRIPTION_ID"

          echo "Current account:"
          az account show

      - name: Get AKS power state
        id: aks_state
        run: |
          echo "Reading AKS power state for ${AKS_RESOURCE_GROUP}/${AKS_CLUSTER_NAME}..."
          STATE=$(az aks show \
            --resource-group "${AKS_RESOURCE_GROUP}" \
            --name "${AKS_CLUSTER_NAME}" \
            --query "powerState.code" -o tsv)

          echo "Current power state: $STATE"
          echo "state=$STATE" >> "$GITHUB_OUTPUT"

      - name: Stop AKS cluster if running
        if: env.AKS_ACTION == 'stop' && steps.aks_state.outputs.state == 'Running'
        run: |
          echo "Requested action: stop"
          echo "Cluster is currently Running - stopping..."
          az aks stop \
            --resource-group "${AKS_RESOURCE_GROUP}" \
            --name "${AKS_CLUSTER_NAME}"
          echo "Cluster stop request submitted."

      - name: Start AKS cluster
        if: env.AKS_ACTION == 'start'
        run: |
          echo "Requested action: start"
          echo "Starting AKS cluster..."
          az aks start \
            --resource-group "${AKS_RESOURCE_GROUP}" \
            --name "${AKS_CLUSTER_NAME}"
          echo "Cluster start request submitted."
